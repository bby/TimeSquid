package com.label.timesquid{	import flash.events.Event;	import flash.net.SharedObject;	import com.label.timesquid.*;	import com.label.timesquid.bill.*;	import com.label.arduino.*;	import com.label.arduino.sensor.*;	import flash.display.MovieClip;	import flash.events.MouseEvent;	import fl.transitions.Fade;	public class TimeSquid extends MovieClip	{		public var rabbit_anim:MovieClip;		public var mary:MovieClip;		public var hit_area:MovieClip;		public var billArm:com.label.timesquid.bill.Arm;		public var startButton:MovieClip;		public var armCalibButton:MovieClip;		public var handCalibButton:MovieClip;		public var startSceneButton:MovieClip;		public var saveButton:MovieClip;		public var calibrator:Calibrator;		var em:EventManager;		var armSensor:FlexSensor;		var handSensor:FlexSensor;		public var mouth:Mouth;		public function TimeSquid()		{			stop();			//Set button names			startButton.buttonText.text = "Start Listener";			armCalibButton.buttonText.text = "Arm Calibration";			handCalibButton.buttonText.text = "Hand Calibration";			startSceneButton.buttonText.text = "Start";			saveButton.buttonText.text = "Save Calibration";			startButton.addEventListener(MouseEvent.CLICK, setup);			saveButton.addEventListener(MouseEvent.CLICK, saveData);			armCalibButton.alpha = 0.5;			handCalibButton.alpha = 0.5;			startSceneButton.alpha = 0.5;		}		//Set up sensors		public function setup(e:Event):void		{			var TEST_MODE:Boolean = true;			armSensor = new FlexSensor();			armSensor.setCalibration(100, 100);			handSensor = new FlexSensor();			handSensor.setCalibration(100, 100);			//Load any existing data;			loadData();			em = EventManager.getInstance();			em.initialize("127.0.0.1", 5331);			em.setTestMode(TEST_MODE);			//Set up Sensors			em.registerAnalogueSensor(armSensor, 3);			em.registerAnalogueSensor(handSensor, 4);			em.connect();			if (TEST_MODE)			{				this.addEventListener(Event.ENTER_FRAME, em.test);			}			//Enable calibrators			armCalibButton.alpha = 1;			handCalibButton.alpha = 1;			startSceneButton.alpha = 1;			armCalibButton.addEventListener(MouseEvent.CLICK, startArmCalibration);			handCalibButton.addEventListener(MouseEvent.CLICK, startHandCalibration);			startSceneButton.addEventListener(MouseEvent.CLICK, startScene);		}		public function addSensorListeners()		{			armSensor.addEventListener(SensorEvent.NEW_VALUE, billArm.sensorEvent);			handSensor.addEventListener(SensorEvent.NEW_VALUE, billArm.bills_hand.sensorEvent);		}		protected function initCalibrator(sensor:FlexSensor):void		{			if (calibrator != null)			{				this.removeChild(calibrator);				var tempSensor = calibrator.sensor;				if (tempSensor != null)				{					sensor.removeEventListener(SensorEvent.NEW_VALUE, calibrator.sensorEvent);				}				calibrator = null;			}			//Add to movie clip			calibrator = new Calibrator(sensor);			this.addChild(calibrator);			//Centre			calibrator.x = 400;			calibrator.y = 300;			//Add Listeners			sensor.addEventListener(SensorEvent.NEW_VALUE, calibrator.sensorEvent);			calibrator.addEventListener(Event.CLOSE, closeCalibrator);		}		protected function startArmCalibration(e:Event):void		{			this.initCalibrator(armSensor);		}		protected function startHandCalibration(e:Event):void		{			this.initCalibrator(handSensor);		}		/**		 * Closes the calibrator		 */		protected function closeCalibrator(e:Event):void		{			if (calibrator != null)			{				this.removeChild(calibrator);				calibrator = null;			}		}		/**		 * Starts the animation scene		 */		protected function startScene(e:Event):void		{			trace("START");			this.gotoAndStop("scene");		}		/**		 * Called by AS in the Scene Frame		 */		protected function sceneStarted():void		{			trace("Scene Started");			addSensorListeners();			//Hide rabbit			rabbit_anim.visible = false;			//Init Mouth			mouth.setup();		}		/**		  * Stores calibration data into flash cookie		  */		protected function saveData(e:Event):void		{			trace("Saving data");			so = SharedObject.getLocal("timesquid");			so.data.handMax = handSensor.max;			so.data.handMin = handSensor.min;			so.data.armMax = armSensor.max;			so.data.armMin = armSensor.min;			so.flush();		}		protected function loadData():void		{			so = SharedObject.getLocal("timesquid");			if (so.data.handMax != null && so.data.handMin != null)			{				handSensor.setCalibration(so.data.handMin, so.data.handMax);			}			if (so.data.armMax != null && so.data.armMin != null)			{				armSensor.setCalibration(so.data.armMin, so.data.armMax);			}		}	}}